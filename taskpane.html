<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>My Taskpane</title>
    <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    <style>
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; font-size: 13px; margin: 12px; }
        details { border: 1px solid #e1e4e8; border-radius: 6px; padding: 8px 10px; background: #fff; margin-bottom: 10px; }
        summary { font-weight: 600; cursor: pointer; outline: none; }
        summary::-webkit-details-marker { display: none; }
        .section-content { margin-top: 8px; }
        .row { margin-bottom: 8px; }
        .row label { font-weight: 600; }
        input[type="text"], input[type="number"], select { width: 100%; box-sizing: border-box; padding: 6px; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 6px 10px; border: 1px solid #d0d7de; background: #f6f8fa; border-radius: 6px; cursor: pointer; }
        button:hover { background: #eef1f4; }
        .btn-row > button { margin-right: 6px; }
        .muted { color: #57606a; }
        .info { font-weight: 600; margin-left: 6px; cursor: help; color: #9ca3af; font-size: 11px; line-height: 1; vertical-align: middle; }
        .stack { display: flex; gap: 8px; flex-wrap: wrap; }
        .stack > * { flex: 1 1 auto; }
        .small { font-size: 12px; }
        .code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
        hr { border: none; border-top: 1px solid #e1e4e8; margin: 12px 0; }
        /* Console dock (fixed bottom, resizable) */
        .console-dock { position: fixed; left: 0; right: 0; bottom: 0; background: #111827; border-top: 1px solid #1f2937; z-index: 9999; }
        .console-dock .console-resizer { height: 6px; cursor: ns-resize; background: #1f2937; }
        .console-dock .console-header { display: flex; align-items: center; justify-content: space-between; padding: 4px 8px; color: #e5e7eb; }
        .console-dock .console-title { font-weight: 600; }
        .console-dock .console-actions { display: inline-flex; align-items: center; gap: 8px; }
        .console-dock .console-toggle { background: transparent; color: #e5e7eb; border: 1px solid #374151; border-radius: 4px; padding: 2px 6px; cursor: pointer; }
        .console-dock .console-toggle:hover { background: #1f2937; }
        .console-dock .console-content { height: var(--console-height, 200px); overflow: auto; padding: 8px; }
        .console-dock.collapsed .console-content { display: none; }
        .live-badge { display: inline-block; background: #16a34a; color: #ffffff; border-radius: 999px; padding: 2px 8px; font-size: 11px; margin-left: 8px; vertical-align: middle; }
        .status-pre { white-space: pre-wrap; background:#000000; color:#ffffff; padding:8px; border:1px solid #333333; border-radius:6px; min-height:120px; max-height:300px; overflow:auto; }
    </style>
</head>

<body>
    <!-- FogLAMP DataLink UI (grouped + collapsible) -->
    <details open>
        <summary>Register FogLAMP Instance</summary>
        <div class="section-content">
            <div class="row">
                <label for="fl-base-url">FogLAMP Base URL <span class="info" title="Example: http://127.0.0.1:8081">ℹ️</span></label>
                <input id="fl-base-url" type="text" placeholder="http://127.0.0.1:8081" />
                <div class="btn-row" style="margin-top: 6px;">
                    <button id="fl-register" type="button" title="Save this FogLAMP URL and set it active">Register</button>
                    <button id="fl-ping" type="button" title="Ping the active FogLAMP instance">Ping</button>
                </div>
            </div>
        </div>
    </details>

    <details open>
        <summary>FogLAMP – Registered Instances <span class="muted small">(select & manage)</span></summary>
        <div class="section-content">
            <div class="row">
                <label for="fl-list">Registered Instances <span class="info" title="Active instance is preselected">ℹ️</span></label>
                <div class="stack">
                    <select id="fl-list"></select>
                    <div class="btn-row" style="align-self: center;">
                        <button id="fl-set-active" type="button" title="Make the selected instance active">Set Active</button>
                        <button id="fl-refresh-list" type="button" title="Ping all and refresh statuses">Check Status</button>
                        <button id="fl-remove" type="button" title="Remove the selected instance">Remove</button>
                    </div>
                </div>
            </div>
            <details>
                <summary>Check summary statistics for active instance</summary>
                <div class="section-content">
                    <div class="row">
                        <button id="fl-check-summary" type="button" title="Ping, fetch statistics and assets summary for the active instance">Check</button>
                    </div>
                    <pre id="fl-summary" class="status-pre"></pre>
                </div>
            </details>
        </div>
    </details>

    <details open>
        <summary>Publish Status <span class="muted small">(ping, statistics, assets → sheet)</span></summary>
        <div class="section-content">
            <div class="row">
                <button id="fl-write-status" type="button" title="Writes ping, statistics, and assets to the 'foglamp status' sheet">Write FogLAMP Status to sheet "foglamp status"</button>
            </div>
        </div>
    </details>

    <details open>
        <summary>Publish Asset Readings <span class="muted small">(fetch → sheet)</span></summary>
        <div class="section-content">
            <div class="row">
                <label for="fl-asset">Asset <span class="info" title="Asset name as shown by the assets API">ℹ️</span></label>
                <input id="fl-asset" type="text" placeholder="e.g. sinusoid" />
            </div>
            <div class="row">
                <label for="fl-datapoint">Datapoint (optional) <span class="info" title="Leave empty to retrieve all datapoints for the asset">ℹ️</span></label>
                <input id="fl-datapoint" type="text" placeholder="e.g. value (leave empty for all)" />
            </div>
            <div class="row">
                <label for="fl-limit">Limit <span class="info" title="Number of latest readings to return (1-10000)">ℹ️</span></label>
                <input id="fl-limit" type="number" min="1" max="10000" value="60" />
            </div>
            <div class="row">
                <label for="fl-skip">Skip <span class="info" title="Number of readings to skip (pagination)">ℹ️</span></label>
                <input id="fl-skip" type="number" min="0" value="0" />
            </div>
            <div class="row">
                <label>Time window (use only one) <span class="info" title="Only one of seconds, minutes, or hours can be used; using a time window disallows limit/skip">ℹ️</span></label>
                <div class="stack">
                    <input id="fl-seconds" type="number" min="1" placeholder="seconds" />
                    <input id="fl-minutes" type="number" min="1" placeholder="minutes" />
                    <input id="fl-hours" type="number" min="1" placeholder="hours" />
                </div>
            </div>
            <div class="row">
                <label for="fl-previous">Previous <span class="info" title="Used with a time window; defines how long ago the data should end">ℹ️</span></label>
                <input id="fl-previous" type="number" min="1" placeholder="previous" />
            </div>
            <div class="row">
                <button id="fl-get-readings" type="button" title="Writes readings to a sheet named 'asset reading - <asset>'">Get Readings → sheet "asset reading - &lt;asset&gt;"</button>
            </div>
        </div>
    </details>

    <!-- Spacer for docked console. Updated dynamically via JS to avoid overlap. -->
    <div id="console-spacer" style="height: 0;"></div>

    <details>
        <summary>Demo <span class="muted small">(template sample)</span></summary>
        <div class="section-content">
            <p>Hit the Run button to paint the selected cells yellow and write the address to cell A1!</p>
            <button id="run-btn" type="button">Run</button>
        </div>
    </details>
    <script>
        // Initialize Office.js
        Office.onReady(function (info) { });

        // Add a click event listener to the button
        document.getElementById("run-btn").addEventListener("click", run);

        // Based on 'Basic API call' sample from ScriptLab
        async function run() {
            await Excel.run(async (context) => {
                const range = context.workbook.getSelectedRange();
                range.format.fill.color = "yellow";
                range.load("address");

                await context.sync();

                const sheets = context.workbook.worksheets;
                sheets.getItem("Sheet1").getRange("A1").values = [["The selected address was " + range.address + "."]];
            });
        }

        // =============================
        // FogLAMP DataLink prototype JS
        // =============================

        const STORAGE_KEYS = {
            INSTANCES: "FOGLAMP_INSTANCES",
            ACTIVE: "FOGLAMP_ACTIVE"
        };

        const els = {
            baseUrl: () => document.getElementById("fl-base-url"),
            register: () => document.getElementById("fl-register"),
            ping: () => document.getElementById("fl-ping"),
            list: () => document.getElementById("fl-list"),
            setActive: () => document.getElementById("fl-set-active"),
            refreshList: () => document.getElementById("fl-refresh-list"),
            remove: () => document.getElementById("fl-remove"),
            writeStatus: () => document.getElementById("fl-write-status"),
            asset: () => document.getElementById("fl-asset"),
            datapoint: () => document.getElementById("fl-datapoint"),
            limit: () => document.getElementById("fl-limit"),
            getReadings: () => document.getElementById("fl-get-readings"),
            status: () => document.getElementById("fl-status")
        };

        // Storage helpers
        function getInstances() {
            try {
                const raw = localStorage.getItem(STORAGE_KEYS.INSTANCES);
                return raw ? JSON.parse(raw) : [];
            } catch (e) {
                return [];
            }
        }

        function saveInstances(instances) {
            localStorage.setItem(STORAGE_KEYS.INSTANCES, JSON.stringify(instances));
        }

        function addInstance(baseUrl) {
            const url = normalizeBaseUrl(baseUrl);
            if (!url) return false;
            const instances = getInstances();
            if (!instances.includes(url)) {
                instances.push(url);
                saveInstances(instances);
            }
            // Set as active by default when added
            localStorage.setItem(STORAGE_KEYS.ACTIVE, url);
            return true;
        }

        function getActiveInstance() {
            const active = localStorage.getItem(STORAGE_KEYS.ACTIVE);
            if (active) return active;
            const instances = getInstances();
            return instances.length ? instances[0] : null;
        }

        function setActiveInstance(url) {
            localStorage.setItem(STORAGE_KEYS.ACTIVE, url);
        }

        function normalizeBaseUrl(input) {
            if (!input) return "";
            let url = input.trim();
            // Enforce http for now (no https until configured)
            if (!/^https?:\/\//i.test(url)) {
                url = "http://" + url;
            }
            // Trim trailing slash
            url = url.replace(/\/$/, "");
            return url;
        }

        function updateStatus(msg, obj) {
            const out = [msg];
            if (obj !== undefined) {
                try {
                    out.push(JSON.stringify(obj, null, 2));
                } catch (e) {
                    out.push(String(obj));
                }
            }
            els.status().textContent = out.join("\n");
            // Auto-scroll console content to bottom when new logs arrive
            const container = document.querySelector('.console-dock .console-content');
            if (container) container.scrollTop = container.scrollHeight;
        }

        function updateSummary(preEl, payload) {
            try {
                preEl.textContent = JSON.stringify(payload, null, 2);
            } catch (e) {
                preEl.textContent = String(payload);
            }
        }

        async function populateList() {
            const sel = els.list();
            while (sel.firstChild) sel.removeChild(sel.firstChild);
            const instances = getInstances();
            const active = getActiveInstance();
            // Move active to front
            const ordered = [...instances].sort((a,b) => (a===active? -1 : b===active? 1 : 0));
            // Ping each to derive status dots
            for (const u of ordered) {
                let ok = false;
                try {
                    const res = await fetch(u + "/foglamp/ping", { method: "GET" });
                    ok = res.ok;
                } catch (e) { ok = false; }
                const opt = document.createElement("option");
                opt.value = u;
                const dot = ok ? "🟢" : "⚪"; // green = ok, white/grey = not reachable
                opt.textContent = `${dot} ${u}${u===active? " (active)" : ""}`;
                sel.appendChild(opt);
            }
            // Ensure active selected by default
            if (active) sel.value = active;
        }

        // FogLAMP API helpers
        async function foglampPing(baseUrl) {
            const res = await fetch(baseUrl + "/foglamp/ping");
            if (!res.ok) throw new Error("Ping failed: " + res.status);
            return res.json();
        }

        async function foglampStatistics(baseUrl) {
            const res = await fetch(baseUrl + "/foglamp/statistics");
            if (!res.ok) throw new Error("Statistics failed: " + res.status);
            return res.json();
        }

        async function foglampAssets(baseUrl) {
            const res = await fetch(baseUrl + "/foglamp/asset");
            if (!res.ok) throw new Error("Assets failed: " + res.status);
            return res.json();
        }

        async function foglampAssetReadings(baseUrl, asset, datapoint, limit) {
            const dp = (datapoint || "").trim();
            const path = dp ? `/foglamp/asset/${asset}/${dp}` : `/foglamp/asset/${asset}`;
            const params = new URLSearchParams();
            if (limit != null) params.set("limit", String(limit));
            const skipVal = document.getElementById("fl-skip").value;
            if (skipVal) params.set("skip", String(parseInt(skipVal, 10)));
            const sec = document.getElementById("fl-seconds").value;
            const min = document.getElementById("fl-minutes").value;
            const hr = document.getElementById("fl-hours").value;
            const prev = document.getElementById("fl-previous").value;
            if (sec) params.set("seconds", String(parseInt(sec, 10)));
            else if (min) params.set("minutes", String(parseInt(min, 10)));
            else if (hr) params.set("hours", String(parseInt(hr, 10)));
            if (prev) params.set("previous", String(parseInt(prev, 10)));
            const url = `${baseUrl}${path}?${params.toString()}`;
            const res = await fetch(url);
            if (!res.ok) throw new Error("Readings failed: " + res.status);
            return res.json();
        }

        // Excel helpers
        async function ensureWorksheet(context, name) {
            const sheets = context.workbook.worksheets;
            let sheet;
            try {
                sheet = sheets.getItem(name);
                // Touch a property to ensure it exists
                sheet.load("name");
                await context.sync();
            } catch (e) {
                sheet = sheets.add(name);
                await context.sync();
            }
            return sheet;
        }

        function writeTable(rangeObj, rows, header) {
            if (header && header.length) {
                rangeObj.getCell(0, 0).getResizedRange(0, header.length - 1).values = [header];
                if (rows.length) {
                    rangeObj.getOffsetRange(1, 0).getResizedRange(rows.length - 1, header.length - 1).values = rows;
                }
            } else if (rows.length) {
                rangeObj.getResizedRange(rows.length - 1, rows[0].length - 1).values = rows;
            }
        }

        function toKeyValueRows(obj) {
            return Object.keys(obj || {}).map(k => [k, stringifyCell(obj[k])]);
        }

        function stringifyCell(v) {
            if (v === null || v === undefined) return "";
            if (typeof v === "object") return JSON.stringify(v);
            return String(v);
        }

        function flattenAssets(list) {
            // Common shape: [{ asset: "name", count: N }]
            if (!Array.isArray(list)) return { header: ["raw_json"], rows: [[JSON.stringify(list)]] };
            const header = ["asset", "count"];
            const rows = list.map(it => [it.asset || it.name || "", it.count != null ? it.count : ""]);
            return { header, rows };
        }

        function flattenStatistics(list) {
            // Often an array of { key: "READINGS", value: 123 }
            if (!Array.isArray(list)) return { header: ["raw_json"], rows: [[JSON.stringify(list)]] };
            const header = ["key", "value"];
            const rows = list.map(it => [it.key || it.statistic || it.name || "", it.value != null ? it.value : ""]);
            return { header, rows };
        }

        function flattenReadings(list) {
            // Common shape: [{ asset, timestamp, reading: {dp1: v1, dp2: v2, ...} }]
            if (!Array.isArray(list)) return { header: ["raw_json"], rows: [[JSON.stringify(list)]] };
            const dpSet = new Set();
            list.forEach(it => {
                const reading = it.reading || it.readings || {};
                Object.keys(reading).forEach(k => dpSet.add(k));
            });
            const datapoints = Array.from(dpSet);
            const header = ["timestamp", "asset", ...datapoints];
            const rows = list.map(it => {
                const r = it.reading || it.readings || {};
                return [it.timestamp || "", it.asset || "", ...datapoints.map(k => r[k] != null ? r[k] : "")];
            });
            return { header, rows };
        }

        // Event wiring
        document.addEventListener("DOMContentLoaded", () => {
            // Wire buttons
            els.register().addEventListener("click", async () => {
                const url = normalizeBaseUrl(els.baseUrl().value);
                if (!url) {
                    updateStatus("Enter a FogLAMP Base URL, e.g. http://127.0.0.1:8081");
                    return;
                }
                addInstance(url);
                populateList();
                updateStatus("Registered instance:", { url });
                try {
                    const data = await foglampPing(url);
                    updateStatus("Ping OK:", data);
                } catch (err) {
                    updateStatus("Ping failed. If this is a browser CORS error, consider running a local proxy or enabling CORS on FogLAMP.", { error: String(err) });
                }
            });

            els.ping().addEventListener("click", async () => {
                const url = getActiveInstance();
                if (!url) return updateStatus("No active instance. Register or select one first.");
                try {
                    const data = await foglampPing(url);
                    updateStatus("Ping OK:", data);
                } catch (err) {
                    updateStatus("Ping failed.", { error: String(err) });
                }
            });

            els.refreshList().addEventListener("click", () => {
                populateList();
                updateStatus("Statuses checked.");
            });
            els.remove().addEventListener("click", () => {
                const sel = els.list();
                const url = sel.value;
                if (!url) return updateStatus("Select an instance to remove.");
                const instances = getInstances().filter(u => u !== url);
                saveInstances(instances);
                if (getActiveInstance() === url) {
                    localStorage.removeItem(STORAGE_KEYS.ACTIVE);
                }
                populateList();
                updateStatus("Removed instance:", { url });
            });

            els.setActive().addEventListener("click", () => {
                const sel = els.list();
                if (!sel.value) return updateStatus("Select an instance first.");
                setActiveInstance(sel.value);
                populateList();
                updateStatus("Active instance set:", { url: sel.value });
            });

            els.writeStatus().addEventListener("click", async () => {
                const url = getActiveInstance();
                if (!url) return updateStatus("No active instance. Register or select one first.");
                updateStatus("Fetching FogLAMP status...");
                try {
                    const [ping, stats, assets] = await Promise.all([
                        foglampPing(url).catch(e => ({ error: String(e) })),
                        foglampStatistics(url).catch(e => ({ error: String(e) })),
                        foglampAssets(url).catch(e => ({ error: String(e) }))
                    ]);

                    await Excel.run(async (context) => {
                        const sheet = await ensureWorksheet(context, "foglamp status");
                        const start = sheet.getRange("A1");

                        // Clear a reasonable area first
                        sheet.getUsedRange().clear();

                        // Ping section
                        start.values = [["Ping"]];
                        const pingRows = Array.isArray(ping) ? ping : toKeyValueRows(ping || {});
                        writeTable(start.getOffsetRange(1, 0), pingRows, ["key", "value"]);

                        // Statistics section
                        const statsHeaderCell = start.getOffsetRange(pingRows.length + 3, 0);
                        statsHeaderCell.values = [["Statistics"]];
                        const { header: statsHeader, rows: statsRows } = flattenStatistics(stats);
                        writeTable(statsHeaderCell.getOffsetRange(1, 0), statsRows, statsHeader);

                        // Assets section
                        const assetsHeaderCell = statsHeaderCell.getOffsetRange(statsRows.length + 3, 0);
                        assetsHeaderCell.values = [["Assets"]];
                        const { header: assetsHeader, rows: assetsRows } = flattenAssets(assets);
                        writeTable(assetsHeaderCell.getOffsetRange(1, 0), assetsRows, assetsHeader);
                    });

                    updateStatus("FogLAMP status written to sheet 'foglamp status'.");
                } catch (err) {
                    updateStatus("Failed to write FogLAMP status.", { error: String(err) });
                }
            });

            els.getReadings().addEventListener("click", async () => {
                const url = getActiveInstance();
                if (!url) return updateStatus("No active instance. Register or select one first.");
                const asset = (els.asset().value || "").trim();
                const datapoint = (els.datapoint().value || "").trim();
                const limit = Math.max(1, Math.min(10000, parseInt(els.limit().value || "60", 10)));
                if (!asset) return updateStatus("Enter an asset name.");
                updateStatus("Fetching readings...");
                try {
                    const data = await foglampAssetReadings(url, asset, datapoint, limit);
                    const { header, rows } = flattenReadings(data);
                    const sheetName = `asset reading - ${asset}`;
                    await Excel.run(async (context) => {
                        const sheet = await ensureWorksheet(context, sheetName);
                        sheet.getUsedRange().clear();
                        const start = sheet.getRange("A1");
                        writeTable(start, rows, header);
                    });
                    updateStatus(`Wrote ${rows.length} rows to sheet '${sheetName}'.`);
                } catch (err) {
                    updateStatus("Failed to fetch/write readings.", { error: String(err) });
                }
            });

            // Initial render
            populateList();

            // Wire summary checker
            const summaryBtn = document.getElementById("fl-check-summary");
            const summaryPre = document.getElementById("fl-summary");
            summaryBtn.addEventListener("click", async () => {
                const url = getActiveInstance();
                if (!url) return updateSummary(summaryPre, { error: "No active instance" });
                updateSummary(summaryPre, { status: "Checking..." });
                try {
                    const [ping, stats, assets] = await Promise.all([
                        foglampPing(url).catch(e => ({ error: String(e) })),
                        foglampStatistics(url).catch(e => ({ error: String(e) })),
                        foglampAssets(url).catch(e => ({ error: String(e) }))
                    ]);
                    updateSummary(summaryPre, { ping, statistics: stats, assets });
                } catch (e) {
                    updateSummary(summaryPre, { error: String(e) });
                }
            });

            // Build docked console
            const dock = document.createElement('div');
            dock.className = 'console-dock collapsed';
            dock.style.setProperty('--console-height', '200px');
            dock.innerHTML = `
                <div class="console-resizer" title="Drag to resize"></div>
                <div class="console-header">
                    <div class="console-title">Console <span class="muted small">live logs & messages</span></div>
                    <div class="console-actions">
                        <span class="live-badge" title="Status updates appear here in real time">LIVE</span>
                        <button class="console-toggle" id="console-toggle" title="Expand/Collapse">▲</button>
                    </div>
                </div>
                <div class="console-content"><pre id="fl-status" class="status-pre"></pre></div>
            `;
            document.body.appendChild(dock);

            // Manage spacer height to avoid overlap with content
            const spacer = document.getElementById('console-spacer');
            function updateSpacer() {
                if (dock.classList.contains('collapsed')) {
                    spacer.style.height = '0px';
                } else {
                    const h = parseInt(getComputedStyle(dock).getPropertyValue('--console-height')) || 200;
                    spacer.style.height = (h + 28) + 'px'; // include header+resizer
                }
            }

            // Toggle expand/collapse
            const toggleBtn = document.getElementById('console-toggle');
            toggleBtn.addEventListener('click', () => {
                const collapsed = dock.classList.toggle('collapsed');
                toggleBtn.textContent = collapsed ? '▲' : '▼';
                updateSpacer();
            });

            // Resizing logic
            const resizer = dock.querySelector('.console-resizer');
            let startY = 0;
            let startH = 200;
            function onMouseMove(e) {
                const dy = startY - e.clientY; // dragging up increases height
                let newH = Math.max(100, Math.min(500, startH + dy));
                dock.style.setProperty('--console-height', newH + 'px');
                updateSpacer();
            }
            function onMouseUp() {
                window.removeEventListener('mousemove', onMouseMove);
                window.removeEventListener('mouseup', onMouseUp);
            }
            resizer.addEventListener('mousedown', (e) => {
                startY = e.clientY;
                const current = parseInt(getComputedStyle(dock).getPropertyValue('--console-height')) || 200;
                startH = current;
                window.addEventListener('mousemove', onMouseMove);
                window.addEventListener('mouseup', onMouseUp);
            });

            // Start collapsed with spacer=0
            updateSpacer();
        });

    </script>
</body>

</html>
