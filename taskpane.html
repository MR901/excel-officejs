<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>My Taskpane</title>
    <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
</head>

<body>
    <!-- Demo button from template -->
    <p>Hit the Run button to paint the selected cells yellow and write the address to cell A1!</p>
    <button id="run-btn" type="button">Run</button>

    <hr />

    <!-- FogLAMP DataLink prototype UI -->
    <h3>FogLAMP DataLink</h3>
    <div style="margin-bottom: 8px;">
        <label for="fl-base-url">FogLAMP Base URL (HTTP only for now):</label><br />
        <input id="fl-base-url" type="text" placeholder="http://127.0.0.1:8081" style="width: 100%;" />
        <div style="margin-top: 6px;">
            <button id="fl-register" type="button">Register</button>
            <button id="fl-ping" type="button">Ping</button>
        </div>
    </div>

    <div style="margin-bottom: 8px;">
        <label for="fl-list">Registered FogLAMP instances:</label><br />
        <select id="fl-list" style="width: 100%;"></select>
        <div style="margin-top: 6px;">
            <button id="fl-set-active" type="button">Set Active</button>
            <button id="fl-refresh-list" type="button">Refresh List</button>
        </div>
    </div>

    <div style="margin-bottom: 8px;">
        <button id="fl-write-status" type="button">Write FogLAMP Status to sheet "foglamp status"</button>
    </div>

    <fieldset style="margin-top: 8px;">
        <legend>Get Readings for Asset</legend>
        <div style="margin-bottom: 6px;">
            <label for="fl-asset">Asset:</label><br />
            <input id="fl-asset" type="text" placeholder="e.g. sinusoid" style="width: 100%;" />
        </div>
        <div style="margin-bottom: 6px;">
            <label for="fl-datapoint">Datapoint (optional):</label><br />
            <input id="fl-datapoint" type="text" placeholder="e.g. value (leave empty for all)" style="width: 100%;" />
        </div>
        <div style="margin-bottom: 6px;">
            <label for="fl-limit">Limit:</label><br />
            <input id="fl-limit" type="number" min="1" max="10000" value="60" style="width: 100%;" />
        </div>
        <button id="fl-get-readings" type="button">Get Readings â†’ sheet "asset reading - &lt;asset&gt;"</button>
    </fieldset>

    <pre id="fl-status" style="white-space: pre-wrap; background:#f6f8fa; padding:8px; margin-top:10px; border:1px solid #e1e4e8;"></pre>
    <script>
        // Initialize Office.js
        Office.onReady(function (info) { });

        // Add a click event listener to the button
        document.getElementById("run-btn").addEventListener("click", run);

        // Based on 'Basic API call' sample from ScriptLab
        async function run() {
            await Excel.run(async (context) => {
                const range = context.workbook.getSelectedRange();
                range.format.fill.color = "yellow";
                range.load("address");

                await context.sync();

                const sheets = context.workbook.worksheets;
                sheets.getItem("Sheet1").getRange("A1").values = [["The selected address was " + range.address + "."]];
            });
        }

        // =============================
        // FogLAMP DataLink prototype JS
        // =============================

        const STORAGE_KEYS = {
            INSTANCES: "FOGLAMP_INSTANCES",
            ACTIVE: "FOGLAMP_ACTIVE"
        };

        const els = {
            baseUrl: () => document.getElementById("fl-base-url"),
            register: () => document.getElementById("fl-register"),
            ping: () => document.getElementById("fl-ping"),
            list: () => document.getElementById("fl-list"),
            setActive: () => document.getElementById("fl-set-active"),
            refreshList: () => document.getElementById("fl-refresh-list"),
            writeStatus: () => document.getElementById("fl-write-status"),
            asset: () => document.getElementById("fl-asset"),
            datapoint: () => document.getElementById("fl-datapoint"),
            limit: () => document.getElementById("fl-limit"),
            getReadings: () => document.getElementById("fl-get-readings"),
            status: () => document.getElementById("fl-status")
        };

        // Storage helpers
        function getInstances() {
            try {
                const raw = localStorage.getItem(STORAGE_KEYS.INSTANCES);
                return raw ? JSON.parse(raw) : [];
            } catch (e) {
                return [];
            }
        }

        function saveInstances(instances) {
            localStorage.setItem(STORAGE_KEYS.INSTANCES, JSON.stringify(instances));
        }

        function addInstance(baseUrl) {
            const url = normalizeBaseUrl(baseUrl);
            if (!url) return false;
            const instances = getInstances();
            if (!instances.includes(url)) {
                instances.push(url);
                saveInstances(instances);
            }
            // Set as active by default when added
            localStorage.setItem(STORAGE_KEYS.ACTIVE, url);
            return true;
        }

        function getActiveInstance() {
            const active = localStorage.getItem(STORAGE_KEYS.ACTIVE);
            if (active) return active;
            const instances = getInstances();
            return instances.length ? instances[0] : null;
        }

        function setActiveInstance(url) {
            localStorage.setItem(STORAGE_KEYS.ACTIVE, url);
        }

        function normalizeBaseUrl(input) {
            if (!input) return "";
            let url = input.trim();
            // Enforce http for now (no https until configured)
            if (!/^https?:\/\//i.test(url)) {
                url = "http://" + url;
            }
            // Trim trailing slash
            url = url.replace(/\/$/, "");
            return url;
        }

        function updateStatus(msg, obj) {
            const out = [msg];
            if (obj !== undefined) {
                try {
                    out.push(JSON.stringify(obj, null, 2));
                } catch (e) {
                    out.push(String(obj));
                }
            }
            els.status().textContent = out.join("\n");
        }

        function populateList() {
            const sel = els.list();
            while (sel.firstChild) sel.removeChild(sel.firstChild);
            const instances = getInstances();
            const active = getActiveInstance();
            instances.forEach(u => {
                const opt = document.createElement("option");
                opt.value = u;
                opt.textContent = u + (u === active ? " (active)" : "");
                sel.appendChild(opt);
            });
        }

        // FogLAMP API helpers
        async function foglampPing(baseUrl) {
            const res = await fetch(baseUrl + "/foglamp/ping");
            if (!res.ok) throw new Error("Ping failed: " + res.status);
            return res.json();
        }

        async function foglampStatistics(baseUrl) {
            const res = await fetch(baseUrl + "/foglamp/statistics");
            if (!res.ok) throw new Error("Statistics failed: " + res.status);
            return res.json();
        }

        async function foglampAssets(baseUrl) {
            const res = await fetch(baseUrl + "/foglamp/asset");
            if (!res.ok) throw new Error("Assets failed: " + res.status);
            return res.json();
        }

        async function foglampAssetReadings(baseUrl, asset, datapoint, limit) {
            const dp = (datapoint || "").trim();
            const path = dp ? `/foglamp/asset/${asset}/${dp}` : `/foglamp/asset/${asset}`;
            const url = `${baseUrl}${path}?limit=${encodeURIComponent(limit)}`;
            const res = await fetch(url);
            if (!res.ok) throw new Error("Readings failed: " + res.status);
            return res.json();
        }

        // Excel helpers
        async function ensureWorksheet(context, name) {
            const sheets = context.workbook.worksheets;
            let sheet;
            try {
                sheet = sheets.getItem(name);
                // Touch a property to ensure it exists
                sheet.load("name");
                await context.sync();
            } catch (e) {
                sheet = sheets.add(name);
                await context.sync();
            }
            return sheet;
        }

        function writeTable(rangeObj, rows, header) {
            if (header && header.length) {
                rangeObj.getCell(0, 0).getResizedRange(0, header.length - 1).values = [header];
                if (rows.length) {
                    rangeObj.getOffsetRange(1, 0).getResizedRange(rows.length - 1, header.length - 1).values = rows;
                }
            } else if (rows.length) {
                rangeObj.getResizedRange(rows.length - 1, rows[0].length - 1).values = rows;
            }
        }

        function toKeyValueRows(obj) {
            return Object.keys(obj || {}).map(k => [k, stringifyCell(obj[k])]);
        }

        function stringifyCell(v) {
            if (v === null || v === undefined) return "";
            if (typeof v === "object") return JSON.stringify(v);
            return String(v);
        }

        function flattenAssets(list) {
            // Common shape: [{ asset: "name", count: N }]
            if (!Array.isArray(list)) return { header: ["raw_json"], rows: [[JSON.stringify(list)]] };
            const header = ["asset", "count"];
            const rows = list.map(it => [it.asset || it.name || "", it.count != null ? it.count : ""]);
            return { header, rows };
        }

        function flattenStatistics(list) {
            // Often an array of { key: "READINGS", value: 123 }
            if (!Array.isArray(list)) return { header: ["raw_json"], rows: [[JSON.stringify(list)]] };
            const header = ["key", "value"];
            const rows = list.map(it => [it.key || it.statistic || it.name || "", it.value != null ? it.value : ""]);
            return { header, rows };
        }

        function flattenReadings(list) {
            // Common shape: [{ asset, timestamp, reading: {dp1: v1, dp2: v2, ...} }]
            if (!Array.isArray(list)) return { header: ["raw_json"], rows: [[JSON.stringify(list)]] };
            const dpSet = new Set();
            list.forEach(it => {
                const reading = it.reading || it.readings || {};
                Object.keys(reading).forEach(k => dpSet.add(k));
            });
            const datapoints = Array.from(dpSet);
            const header = ["timestamp", "asset", ...datapoints];
            const rows = list.map(it => {
                const r = it.reading || it.readings || {};
                return [it.timestamp || "", it.asset || "", ...datapoints.map(k => r[k] != null ? r[k] : "")];
            });
            return { header, rows };
        }

        // Event wiring
        document.addEventListener("DOMContentLoaded", () => {
            // Wire buttons
            els.register().addEventListener("click", async () => {
                const url = normalizeBaseUrl(els.baseUrl().value);
                if (!url) {
                    updateStatus("Enter a FogLAMP Base URL, e.g. http://127.0.0.1:8081");
                    return;
                }
                addInstance(url);
                populateList();
                updateStatus("Registered instance:", { url });
                try {
                    const data = await foglampPing(url);
                    updateStatus("Ping OK:", data);
                } catch (err) {
                    updateStatus("Ping failed. If this is a browser CORS error, consider running a local proxy or enabling CORS on FogLAMP.", { error: String(err) });
                }
            });

            els.ping().addEventListener("click", async () => {
                const url = getActiveInstance();
                if (!url) return updateStatus("No active instance. Register or select one first.");
                try {
                    const data = await foglampPing(url);
                    updateStatus("Ping OK:", data);
                } catch (err) {
                    updateStatus("Ping failed.", { error: String(err) });
                }
            });

            els.refreshList().addEventListener("click", () => {
                populateList();
                updateStatus("List refreshed.");
            });

            els.setActive().addEventListener("click", () => {
                const sel = els.list();
                if (!sel.value) return updateStatus("Select an instance first.");
                setActiveInstance(sel.value);
                populateList();
                updateStatus("Active instance set:", { url: sel.value });
            });

            els.writeStatus().addEventListener("click", async () => {
                const url = getActiveInstance();
                if (!url) return updateStatus("No active instance. Register or select one first.");
                updateStatus("Fetching FogLAMP status...");
                try {
                    const [ping, stats, assets] = await Promise.all([
                        foglampPing(url).catch(e => ({ error: String(e) })),
                        foglampStatistics(url).catch(e => ({ error: String(e) })),
                        foglampAssets(url).catch(e => ({ error: String(e) }))
                    ]);

                    await Excel.run(async (context) => {
                        const sheet = await ensureWorksheet(context, "foglamp status");
                        const start = sheet.getRange("A1");

                        // Clear a reasonable area first
                        sheet.getUsedRange().clear();

                        // Ping section
                        start.values = [["Ping"]];
                        const pingRows = Array.isArray(ping) ? ping : toKeyValueRows(ping || {});
                        writeTable(start.getOffsetRange(1, 0), pingRows, ["key", "value"]);

                        // Statistics section
                        const statsHeaderCell = start.getOffsetRange(pingRows.length + 3, 0);
                        statsHeaderCell.values = [["Statistics"]];
                        const { header: statsHeader, rows: statsRows } = flattenStatistics(stats);
                        writeTable(statsHeaderCell.getOffsetRange(1, 0), statsRows, statsHeader);

                        // Assets section
                        const assetsHeaderCell = statsHeaderCell.getOffsetRange(statsRows.length + 3, 0);
                        assetsHeaderCell.values = [["Assets"]];
                        const { header: assetsHeader, rows: assetsRows } = flattenAssets(assets);
                        writeTable(assetsHeaderCell.getOffsetRange(1, 0), assetsRows, assetsHeader);
                    });

                    updateStatus("FogLAMP status written to sheet 'foglamp status'.");
                } catch (err) {
                    updateStatus("Failed to write FogLAMP status.", { error: String(err) });
                }
            });

            els.getReadings().addEventListener("click", async () => {
                const url = getActiveInstance();
                if (!url) return updateStatus("No active instance. Register or select one first.");
                const asset = (els.asset().value || "").trim();
                const datapoint = (els.datapoint().value || "").trim();
                const limit = Math.max(1, Math.min(10000, parseInt(els.limit().value || "60", 10)));
                if (!asset) return updateStatus("Enter an asset name.");
                updateStatus("Fetching readings...");
                try {
                    const data = await foglampAssetReadings(url, asset, datapoint, limit);
                    const { header, rows } = flattenReadings(data);
                    const sheetName = `asset reading - ${asset}`;
                    await Excel.run(async (context) => {
                        const sheet = await ensureWorksheet(context, sheetName);
                        sheet.getUsedRange().clear();
                        const start = sheet.getRange("A1");
                        writeTable(start, rows, header);
                    });
                    updateStatus(`Wrote ${rows.length} rows to sheet '${sheetName}'.`);
                } catch (err) {
                    updateStatus("Failed to fetch/write readings.", { error: String(err) });
                }
            });

            // Initial render
            populateList();
        });

    </script>
</body>

</html>
