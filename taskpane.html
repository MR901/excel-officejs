<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>FogLAMP Data Link</title>
    <link rel="stylesheet" href="src/styles/taskpane.css">
    <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    <script type="text/javascript" src="smart-connection.js?v=4"></script>
    <script type="module" src="src/js/main.js"></script>
</head>

<body>
    <!-- Scrollable Interaction Area -->
    <div class="app-body">
        <!-- Overview / Connection Status -->
        <details open>
            <summary>Overview</summary>
        <div class="section-content">
                <div class="row" style="margin-bottom: 12px;">
                    <div id="environment-badge" class="badge">Detecting...</div>
                    <div id="connectivity-badge" class="badge">Checking...</div>
                    <div id="proxy-badge" class="badge">Unknown</div>
                </div>
                <div class="row" style="margin-bottom: 12px;">
                    <div id="active-instance-display" class="small muted">No active instance</div>
                </div>
            <div class="row">
                <div class="stack">
                    <button id="update-connections" type="button" title="Check all instances, update status, and refresh connections">Refresh Connections</button>
                </div>
            </div>
                <div id="proxy-guidance" class="feedback-area warning" style="display: none;">
                    <strong>💡 Excel Web detected:</strong> Run <code>node proxy_server.js</code> locally to access private network instances.
            </div>
        </div>
    </details>

        <!-- FogLAMP Instances (Merged) -->
    <details open>
            <summary>FogLAMP Instances</summary>
        <div class="section-content">
                <!-- Add Instance -->
            <div class="row">
                    <label for="fl-base-url">Add Instance <span class="info" title="Enter FogLAMP URL (e.g., http://127.0.0.1:8081)"><img src="icons/info-icon-16.png" alt="info" /></span></label>
                <div class="stack">
                        <input id="fl-base-url" type="text" placeholder="http://127.0.0.1:8081" />
                        <button id="fl-register" type="button" title="Validate and add this FogLAMP instance">Add</button>
                    </div>
                </div>
                
                <!-- Adaptive Add Feedback -->
                <div id="fl-add-feedback" class="feedback-area" style="display: none;"></div>
                <div id="fl-add-actions" class="row" style="display: none; gap: 6px; margin-top: 6px;">
                    <button id="fl-add-confirm" type="button" class="primary">Add</button>
                    <button id="fl-add-skip" type="button">Skip</button>
            </div>

                <!-- Instance List -->
                <div class="row" style="margin-top: 16px;">
                    <div id="instances-container">
                        <div class="empty-state" id="empty-instances">
                            No instances yet. Add a FogLAMP URL to begin.
                        </div>
                    </div>
                </div>

                <!-- Instance Actions Summary -->
                <div class="row" style="margin-top: 12px;">
            <details>
                        <summary>Instance Summary</summary>
                <div class="section-content">
                    <div class="row">
                                <button id="fl-check-summary" type="button" title="Get comprehensive status (ping + statistics + assets) for active instance">Get Active Instance Details</button>
                    </div>
                    <pre id="fl-summary" class="status-pre"></pre>
                </div>
            </details>
                </div>
        </div>
    </details>

        <!-- Data Actions -->
    <details>
            <summary>Data Actions <span class="muted small">(Excel export)</span></summary>
        <div class="section-content">
                <div class="stack" style="margin-bottom: 12px;">
                    <!-- Export Status -->
                    <div style="border: 1px solid #e5e7eb; border-radius: 6px; padding: 12px;">
            <div class="row">
                            <strong>Export Status</strong>
                            <div class="small muted">Ping, statistics, assets → formatted sheet</div>
            </div>
                        <div class="row">
                            <button id="fl-write-status" type="button" title="Export comprehensive status to Excel sheet">Export Status to Sheet</button>
        </div>
                    </div>

                    <!-- Export Asset Readings -->
                    <div style="border: 1px solid #e5e7eb; border-radius: 6px; padding: 12px;">
            <div class="row">
                            <strong>Export Asset Readings</strong>
                            <div class="small muted">Asset data → formatted sheet</div>
            </div>
            <div class="row">
                            <label class="small" style="margin-bottom: 4px;">Output Type</label>
                <div class="stack" style="gap: 6px;">
                    <label class="small"><input type="radio" name="fl-ot" id="fl-ot-raw" value="raw" title="Raw reading rows with timestamp and datapoints" checked /> Raw Readings</label>
                    <label class="small"><input type="radio" name="fl-ot" id="fl-ot-combined" value="combined" title="Summary and timespan in a single sheet" /> Summary + Time Span</label>
                </div>
            </div>
            <div class="row" id="fl-mode-section">
                            <label class="small" style="margin-bottom: 4px;">Mode</label>
                <div class="stack" style="gap: 6px;">
                    <label class="small"><input type="radio" name="fl-mode" id="fl-mode-latest" value="latest" title="Use limit and optional skip to fetch most recent readings" checked /> Latest (limit/skip)</label>
                    <label class="small"><input type="radio" name="fl-mode" id="fl-mode-window" value="window" title="Specify a time window in seconds, minutes, or hours" /> Time window (choose seconds OR minutes OR hours)</label>
                    <label class="small"><input type="radio" name="fl-mode" id="fl-mode-previous" value="previous" title="Fetch previous N windows (historical)" /> Previous window(s)</label>
                </div>
            </div>
            <div class="row" id="fl-asset-row">
                            <div class="stack">
                                <select id="fl-asset-select" title="Select asset from available assets">
                                    <option value="">Loading assets...</option>
                                </select>
                                <input id="fl-asset" type="text" placeholder="or type asset name" title="Type asset name if not present in the dropdown" />
                            </div>
            </div>
            <div class="row" id="fl-dp-limit-row">
                            <div class="stack">
                                <input id="fl-datapoint" type="text" placeholder="datapoint (optional)" title="Optional: restrict to a specific datapoint key from the asset's readings" />
                                <input id="fl-limit" type="number" min="1" max="10000" value="100" placeholder="limit" title="Number of records to return (1-10000)" style="max-width: 100px;" />
                            </div>
            </div>
            <div class="row" id="fl-skip-row">
                            <input id="fl-skip" type="number" min="0" value="0" placeholder="skip (pagination)" title="Skip this many records (use for pagination)" style="max-width: 120px;" />
            </div>
            <div class="row" id="fl-timewindow-row">
                            <label class="small">Time window (use only one)</label>
                <div class="stack">
                    <input id="fl-seconds" type="number" min="1" placeholder="seconds" title="Window size in seconds (choose only one unit)" />
                    <input id="fl-minutes" type="number" min="1" placeholder="minutes" title="Window size in minutes (choose only one unit)" />
                    <input id="fl-hours" type="number" min="1" placeholder="hours" title="Window size in hours (choose only one unit)" />
                </div>
            </div>
            <div class="row" id="fl-previous-row">
                            <input id="fl-previous" type="number" min="1" placeholder="previous (for historical)" title="Number of previous windows to retrieve (e.g., last N windows)" />
            </div>
            
            <div class="row" id="fl-summary-row">
                            <div id="fl-readings-summary" class="small muted"></div>
            </div>
            <div class="row">
                            <button id="fl-get-readings" type="button" title="Export asset readings to Excel sheet">Get Readings</button>
            </div>
        </div>
                </div>
            </div>
        </details>
    </div>

    <!-- Draggable Console -->
    <div class="app-console">
        <div class="console-resizer" title="Drag to resize console"></div>
        <div class="console-header">
            <div class="console-title">Console <span class="muted small">live logs & messages</span></div>
            <div>
                <button id="clear-console" style="background: transparent; border: 1px solid #4b5563; color: #e5e7eb; padding: 2px 8px; border-radius: 4px; font-size: 10px; cursor: pointer; margin-right: 8px;" title="Clear console logs">Clear</button>
            <span class="live-badge" title="Status updates appear here in real time">LIVE</span>
            </div>
        </div>
        <div class="console-content">
            <pre id="fl-status" class="status-pre"></pre>
        </div>
    </div>
    <script>
        // Basic Office.js initialization for legacy compatibility
        // Main initialization is handled by src/js/main.js modular system
        Office.onReady(function (info) {
            console.log('📋 Office.js ready in taskpane.html - delegating to modular system');
        });

        // =============================
        // FogLAMP DataLink Modular System
        // =============================

        // All functionality has been moved to the modular system in src/js/main.js
        // This includes:
        // - Configuration constants
        // - Storage management 
        // - UI management
        // - Event handling
        // - Asset management
        // - Excel integration
        // - Instance management
        // - Console & logging
        
        // Functions are now available globally via:
        // window.FogLAMP.* - Access to all modules
        // window.getInstances(), window.addInstance(), etc. - Direct access to commonly used functions

        // DOM initialization is now handled by src/js/main.js
        // The modular system will initialize automatically when loaded
        
        // Optional: Add debugging helper for development
        document.addEventListener("DOMContentLoaded", () => {
            // Add debugging helper for development
            window.debugFogLAMP = function() {
                console.log('🐞 FOGLAMP SYSTEM DEBUG:');
                console.log('- FogLAMP modules loaded:', !!window.FogLAMP);
                console.log('- Available modules:', window.FogLAMP ? Object.keys(window.FogLAMP) : 'NOT LOADED');
                console.log('- Office.js available:', typeof Office !== 'undefined');
                console.log('- Excel API available:', typeof Excel !== 'undefined');
                console.log('- getInstances function:', typeof window.getInstances);
                    console.log('- renderInstanceList function:', typeof window.renderInstanceList);
                console.log('- Current instances:', window.getInstances ? window.getInstances() : 'NOT AVAILABLE');
                console.log('- Active instance:', window.getActiveInstance ? window.getActiveInstance() : 'NOT AVAILABLE');
            };
            console.log('🐞 Debug helper available: Call debugFogLAMP() in console');
        });

    </script>
</body>

</html>
