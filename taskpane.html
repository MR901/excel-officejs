<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>FogLAMP Data Link</title>
    <link rel="stylesheet" href="src/styles/taskpane.css">
    <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    <script type="text/javascript" src="smart-connection.js?v=4"></script>
    <script type="module" src="src/js/main.js"></script>
</head>

<body>
    <!-- Scrollable Interaction Area -->
    <div class="app-body">
        <!-- Overview / Connection Status -->
        <details open>
            <summary>Overview</summary>
        <div class="section-content">
                <div class="row" style="margin-bottom: 12px;">
                    <div id="environment-badge" class="badge">Detecting...</div>
                    <div id="connectivity-badge" class="badge">Checking...</div>
                    <div id="proxy-badge" class="badge">Unknown</div>
                </div>
                <div class="row" style="margin-bottom: 12px;">
                    <div id="active-instance-display" class="small muted">No active instance</div>
                </div>
            <div class="row">
                <div class="stack">
                    <button id="update-connections" type="button" title="Check all instances, update status, and refresh connections">Refresh Connections</button>
                </div>
            </div>
                <div id="proxy-guidance" class="feedback-area warning" style="display: none;">
                    <strong>💡 Excel Web detected:</strong> Run <code>node simple-proxy.js</code> locally to access private network instances.
            </div>
        </div>
    </details>

        <!-- FogLAMP Instances (Merged) -->
    <details open>
            <summary>FogLAMP Instances</summary>
        <div class="section-content">
                <!-- Add Instance -->
            <div class="row">
                    <label for="fl-base-url">Add Instance <span class="info" title="Enter FogLAMP URL (e.g., http://127.0.0.1:8081)"><img src="icons/info-icon-16.png" alt="info" /></span></label>
                <div class="stack">
                        <input id="fl-base-url" type="text" placeholder="http://127.0.0.1:8081" />
                        <button id="fl-register" type="button" title="Validate and add this FogLAMP instance">Add</button>
                    </div>
                </div>
                
                <!-- Adaptive Add Feedback -->
                <div id="fl-add-feedback" class="feedback-area" style="display: none;"></div>
                <div id="fl-add-actions" class="row" style="display: none; gap: 6px; margin-top: 6px;">
                    <button id="fl-add-confirm" type="button" class="primary">Add</button>
                    <button id="fl-add-skip" type="button">Skip</button>
            </div>

                <!-- Instance List -->
                <div class="row" style="margin-top: 16px;">
                    <div id="instances-container">
                        <div class="empty-state" id="empty-instances">
                            No instances yet. Add a FogLAMP URL to begin.
                        </div>
                    </div>
                </div>

                <!-- Instance Actions Summary -->
                <div class="row" style="margin-top: 12px;">
            <details>
                        <summary>Instance Summary</summary>
                <div class="section-content">
                    <div class="row">
                                <button id="fl-check-summary" type="button" title="Get comprehensive status (ping + statistics + assets) for active instance">Get Active Instance Details</button>
                    </div>
                    <pre id="fl-summary" class="status-pre"></pre>
                </div>
            </details>
                </div>
        </div>
    </details>

        <!-- Data Actions -->
    <details>
            <summary>Data Actions <span class="muted small">(Excel export)</span></summary>
        <div class="section-content">
                <div class="stack" style="margin-bottom: 12px;">
                    <!-- Export Status -->
                    <div style="border: 1px solid #e5e7eb; border-radius: 6px; padding: 12px;">
            <div class="row">
                            <strong>Export Status</strong>
                            <div class="small muted">Ping, statistics, assets → formatted sheet</div>
            </div>
                        <div class="row">
                            <button id="fl-write-status" type="button" title="Export comprehensive status to Excel sheet">Export Status to Sheet</button>
        </div>
                    </div>

                    <!-- Export Asset Readings -->
                    <div style="border: 1px solid #e5e7eb; border-radius: 6px; padding: 12px;">
            <div class="row">
                            <strong>Export Asset Readings</strong>
                            <div class="small muted">Asset data → formatted sheet</div>
            </div>
            <div class="row">
                            <div class="stack">
                                <select id="fl-asset-select" title="Select asset from available assets">
                                    <option value="">Loading assets...</option>
                                </select>
                                <input id="fl-asset" type="text" placeholder="or type asset name" />
                            </div>
            </div>
            <div class="row">
                            <div class="stack">
                                <input id="fl-datapoint" type="text" placeholder="datapoint (optional)" />
                                <input id="fl-limit" type="number" min="1" max="10000" value="100" placeholder="limit" style="max-width: 100px;" />
                            </div>
            </div>
            <div class="row">
                            <input id="fl-skip" type="number" min="0" value="0" placeholder="skip (pagination)" style="max-width: 120px;" />
            </div>
            <div class="row">
                            <label class="small">Time window (use only one)</label>
                <div class="stack">
                    <input id="fl-seconds" type="number" min="1" placeholder="seconds" />
                    <input id="fl-minutes" type="number" min="1" placeholder="minutes" />
                    <input id="fl-hours" type="number" min="1" placeholder="hours" />
                </div>
            </div>
            <div class="row">
                            <input id="fl-previous" type="number" min="1" placeholder="previous (for historical)" />
            </div>
            <div class="row">
                            <button id="fl-get-readings" type="button" title="Export asset readings to Excel sheet">Get Readings</button>
            </div>
        </div>
                </div>
            </div>
        </details>
    </div>

    <!-- Draggable Console -->
    <div class="app-console">
        <div class="console-resizer" title="Drag to resize console"></div>
        <div class="console-header">
            <div class="console-title">Console <span class="muted small">live logs & messages</span></div>
            <div>
                <button id="clear-console" style="background: transparent; border: 1px solid #4b5563; color: #e5e7eb; padding: 2px 8px; border-radius: 4px; font-size: 10px; cursor: pointer; margin-right: 8px;" title="Clear console logs">Clear</button>
            <span class="live-badge" title="Status updates appear here in real time">LIVE</span>
            </div>
        </div>
        <div class="console-content">
            <pre id="fl-status" class="status-pre"></pre>
        </div>
    </div>
    <script>
        // Initialize Office.js
        Office.onReady(function (info) { });

        // Add a click event listener to the button
        document.getElementById("run-btn") && document.getElementById("run-btn").addEventListener("click", run);

        // Based on 'Basic API call' sample from ScriptLab
        async function run() {
            await Excel.run(async (context) => {
                const range = context.workbook.getSelectedRange();
                range.format.fill.color = "yellow";
                range.load("address");

                await context.sync();

                const sheets = context.workbook.worksheets;
                sheets.getItem("Sheet1").getRange("A1").values = [["The selected address was " + range.address + "."]];
            });
        }

        // =============================
        // FogLAMP DataLink prototype JS
        // =============================

        // Configuration constants (loaded from modules)
        // Available as: window.FogLAMP.config.STORAGE_KEYS, etc.
        const STORAGE_KEYS = window.FogLAMP?.config.STORAGE_KEYS || {
            INSTANCES: "FOGLAMP_INSTANCES",
            ACTIVE: "FOGLAMP_ACTIVE"
        };

        // UI element selectors (loaded from modules)  
        // Available as: window.FogLAMP.elements
        const els = window.FogLAMP?.elements || {
            // Fallback element selectors if modules not loaded yet
            environmentBadge: () => document.getElementById("environment-badge"),
            connectivityBadge: () => document.getElementById("connectivity-badge"),
            proxyBadge: () => document.getElementById("proxy-badge"),
            activeInstanceDisplay: () => document.getElementById("active-instance-display"),
            updateConnections: () => document.getElementById("update-connections"),
            proxyGuidance: () => document.getElementById("proxy-guidance"),
            baseUrl: () => document.getElementById("fl-base-url"),
            register: () => document.getElementById("fl-register"),
            addFeedback: () => document.getElementById("fl-add-feedback"),
            addActions: () => document.getElementById("fl-add-actions"),
            addConfirm: () => document.getElementById("fl-add-confirm"),
            addSkip: () => document.getElementById("fl-add-skip"),
            instancesContainer: () => document.getElementById("instances-container"),
            emptyInstances: () => document.getElementById("empty-instances"),
            checkSummary: () => document.getElementById("fl-check-summary"),
            summary: () => document.getElementById("fl-summary"),
            writeStatus: () => document.getElementById("fl-write-status"),
            assetSelect: () => document.getElementById("fl-asset-select"),
            asset: () => document.getElementById("fl-asset"),
            datapoint: () => document.getElementById("fl-datapoint"),
            limit: () => document.getElementById("fl-limit"),
            skip: () => document.getElementById("fl-skip"),
            seconds: () => document.getElementById("fl-seconds"),
            minutes: () => document.getElementById("fl-minutes"),
            hours: () => document.getElementById("fl-hours"),
            previous: () => document.getElementById("fl-previous"),
            getReadings: () => document.getElementById("fl-get-readings"),
            status: () => document.getElementById("fl-status")
        };

        // Enhanced Instance Storage System
        // =================================
        // This system manages both URL list (for backward compatibility) 
        // and rich metadata for each instance

        // Utility functions (loaded from modules)
        // Available as: window.FogLAMP.utils.getDisplayName, etc.
        const getDisplayName = window.FogLAMP?.utils.getDisplayName || function(instance) {
            // Fallback implementation
            if (instance?.name) return instance.name;
            if (instance?.hostName) return instance.hostName;
            try {
                return new URL(instance.url).hostname;
            } catch (e) {
                return instance.url?.replace(/^https?:\/\//, '').split('/')[0] || 'Unknown Instance';
            }
        };

        // Enhanced storage keys (loaded from modules)
        const ENHANCED_STORAGE_KEYS = window.FogLAMP?.config.ENHANCED_STORAGE_KEYS || {
            ...STORAGE_KEYS,
            INSTANCE_METADATA: 'foglamp_instance_metadata'
        };

        // Status constants (loaded from modules)  
        const INSTANCE_STATUS = window.FogLAMP?.config.INSTANCE_STATUS || {
            SUCCESS: 'success',
            FAILED: 'failed', 
            CHECKING: 'checking',
            UNKNOWN: 'unknown'
        };

        /**
         * Instance metadata structure:
         * {
         *   url: string,
         *   name?: string,           // Optional user-provided name
         *   hostName?: string,       // From FogLAMP /ping response
         *   lastStatus: 'success'|'failed'|'checking'|'unknown',
         *   lastPingMs?: number,     // Response time in milliseconds
         *   lastCheckedAt?: string,  // ISO timestamp
         *   addedAt: string,         // ISO timestamp when first added
         *   lastError?: string       // Last error message if any
         * }
         */

        // ===============================================
        // Instance Storage Functions (Extracted to Module)
        // ===============================================
        // These functions are now loaded from src/js/core/storage.js
        // Available as: window.FogLAMP.storage.getInstanceMetadata(), window.getInstanceMetadata(), etc.
        // Functions loaded via src/js/main.js: 
        // - getInstanceMetadata, saveInstanceMetadata
        // - getInstanceMeta, updateInstanceMeta  
        // - getEnhancedInstances, getInstances
        // - addInstance, removeInstance
        // - getActiveInstance, setActiveInstance
        // - getActiveInstanceWithMeta, normalizeBaseUrl

        // Legacy Storage Functions (Now in Module)
        // =======================================
        // All storage functions moved to src/js/core/storage.js
        // Available globally via window.getInstances(), window.addInstance(), etc.
        // See main.js for complete list of exposed functions

        // Global function exposure now handled by src/js/main.js
        // Functions available via window.getInstances(), window.addInstance(), etc.

        // =============================================
        // UI Management Functions (Now in Modules)
        // =============================================
        // Badge management: ui/badges.js → window.updateOverviewBadges()
        // Instance list: ui/instances.js → window.renderInstanceList()
        // Asset management: assets/manager.js → window.loadAssetsForActiveInstance()
        // Ping management: instances/ping.js → window.pingInstance()
        // Excel integration: excel/integration.js → window.handleExportStatus()
        // Event handling: events/handlers.js → window.setupEventListeners()

        // renderInstanceList() now available from ui/instances.js

        // editInstanceName() now available from ui/instances.js

        // Console & Logging Functions (Now in Module)
        // Available globally via window.logMessage(), window.clearConsole(), etc.

        // Instance Management Functions
        // ============================

        /**
         * Ping specific instance and update its status
         * @param {string} url - Instance URL to ping
         */
        // async function pingInstance() moved to modular system

        /**
         * Set instance as active
         * @param {string} url - Instance URL to set as active
         */
        // async function setInstanceActive() moved to modular system

        /**
         * Remove instance with confirmation
         * @param {string} url - Instance URL to remove
         */
        // function removeInstanceWithConfirm() moved to modular system

        /**
         * Get statistics for specific instance with proper error handling
         * @param {string} url - Instance URL
         */
        // async function getInstanceStatistics() moved to modular system

        /**
         * Enhanced asset readings API call with all parameters
         * @param {Object} params - API parameters object
         * @returns {Promise} Asset readings data
         */
        // foglampAssetReadingsSmartWithParams() moved to excel/integration.js

        // Adaptive Add Flow Implementation
        // ===============================

        /**
         * Show add feedback message
         * @param {string} message - Feedback message
         * @param {string} type - Message type: 'success', 'warning', 'error'
         */
        // function showAddFeedback() moved to modular system

        /**
         * Hide add feedback
         */
        // function hideAddFeedback() moved to modular system

        /**
         * Show/hide add action buttons
         * @param {boolean} show - Whether to show buttons
         * @param {string} url - URL being added
         * @param {Object} pingResult - Ping result data
         */
        // function toggleAddActions() moved to modular system

        /**
         * Confirm and add instance with metadata
         * @param {string} url - Instance URL
         * @param {Object} pingResult - Ping result data
         */
        // async function confirmAddInstance() moved to modular system

        /**
         * Ping URL with timeout for validation
         * @param {string} url - URL to ping
         * @param {number} timeoutMs - Timeout in milliseconds
         * @returns {Promise} Ping result
         */
        // async function pingUrlForValidation() moved to modular system

        // Asset Management Functions
        // =========================

        /**
         * Load assets for the active instance
         */
        // async function loadAssetsForActiveInstance() moved to modular system

        /**
         * Refresh asset list for active instance - used by Refresh Status button
         * Includes proper error handling and logging
         */
        // async function refreshAssetListForActiveInstance() moved to modular system

        /**
         * Enhanced asset input synchronization with debouncing to prevent race conditions
         */
        // function syncAssetInputs() moved to modular system

        // Legacy Helper Functions (Updated for new UI)
        // ===========================================

        /**
         * Update status in console (legacy compatibility)
         * @param {string} message - Status message
         * @param {Object} data - Optional data object
         */
        // function updateStatus() moved to modular system

        /**
         * Legacy populate list function (updated for new UI)
         */
        // async function populateList() moved to modular system

        // Event Handlers
        // ==============

        /**
         * Handle adaptive Add button click
         */
        // async function handleAddInstance() moved to modular system

        /**
         * Handle refresh status button click
         */
        // async function handleRefreshStatus() moved to modular system

        /**
         * Handle reset connections - force complete connection state reset
         */
        // async function handleResetConnections() moved to modular system

        /**
         * Setup all event listeners for the enhanced UI
         */
        // function setupEventListeners() moved to modular system

        /**
         * Initialize UI components and load initial data
         */
        // initializeUI() now handled by modular system in main.js

        // normalizeBaseUrl now available from src/js/core/storage.js

        // function updateStatus() moved to modular system

        // updateSummary now available from src/js/ui/console.js

        // async function populateList() moved to modular system

        // Note: FogLAMP API calls now use smart connection manager (smart-connection.js)
        // Functions: foglampPingSmart, foglampStatisticsSmart, foglampAssetsSmart, foglampAssetReadingsSmart

        // Excel helpers
        // async function ensureWorksheet() moved to modular system

        // function writeTable() moved to modular system

        // function toKeyValueRows() moved to modular system

        // function stringifyCell() moved to modular system

        // function flattenAssets() moved to modular system

        // function flattenStatistics() moved to modular system

        // function flattenReadings() moved to modular system

        // 🔄 CRITICAL FIX: Bidirectional Status Sync Functions
        // Prevents dual status system desync between taskpane metadata and smart manager
        
        /**
         * Sync taskpane metadata with smart manager accessibility status
         * Call this after smart manager discovery to ensure UI reflects smart manager state
         */
        // function syncFromSmartManager() moved to modular system
        
        /**
         * Force smart manager to re-discover instances
         * Call this after taskpane metadata updates to ensure smart manager reflects latest state
         */
        // async function syncToSmartManager() moved to modular system

        // Smart Connection Management with enhanced error handling
        // initializeSmartConnections() now handled by modular system in main.js

        function updateEnvironmentInfo(message) {
            const el = document.getElementById('environment-info');
            if (el) el.textContent = message;
        }

        function updateConnectionSummary(message) {
            const el = document.getElementById('connection-summary');
            if (el) el.textContent = message;
        }

        // function updateConnectionStatus() moved to modular system

        // async function populateSmartInstances() moved to modular system

        // Enhanced Event Wiring & Initialization
        document.addEventListener("DOMContentLoaded", async () => {
            try {
                // Wait for modules to load (main.js handles full initialization)
                let retries = 0;
                const maxRetries = 50; // 5 seconds max wait
                
                while (!window.FogLAMP && retries < maxRetries) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    retries++;
                }
                
                if (!window.FogLAMP) {
                    console.error('❌ Failed to load FogLAMP modules - initialization aborted');
                    return;
                }
                
                console.log('✅ FogLAMP modular system ready - taskpane.html initialization complete');
                console.log('📋 Available modules:', Object.keys(window.FogLAMP));
                
                // Ensure all components are properly initialized
                if (window.FogLAMP.app && window.FogLAMP.app.initialize) {
                    console.log('🚀 Triggering manual app initialization...');
                    await window.FogLAMP.app.initialize();
                }
                
                // Force instance list rendering if not already done
                if (window.renderInstanceList) {
                    console.log('🔄 Force rendering instance list...');
                    window.renderInstanceList();
                }
                
                // Update badges to show current status
                if (window.updateOverviewBadges) {
                    console.log('🔄 Force updating overview badges...');
                    window.updateOverviewBadges();
                }
                
                // Add debugging helper
                window.debugInstanceList = function() {
                    console.log('🐞 INSTANCE LIST DEBUG:');
                    console.log('- getInstances():', window.getInstances ? window.getInstances() : 'NOT AVAILABLE');
                    console.log('- getEnhancedInstances():', window.getEnhancedInstances ? window.getEnhancedInstances() : 'NOT AVAILABLE');
                    console.log('- getActiveInstance():', window.getActiveInstance ? window.getActiveInstance() : 'NOT AVAILABLE');
                    console.log('- renderInstanceList function:', typeof window.renderInstanceList);
                    console.log('- instances container element:', document.getElementById('instances-container'));
                    console.log('- empty state element:', document.getElementById('empty-instances'));
                    
                    // Try to force render
                    if (window.renderInstanceList) {
                        console.log('🔄 Attempting to force render...');
                        window.renderInstanceList();
                    }
                };
                console.log('🐞 Debug helper available: Call debugInstanceList() in console');
                
            } catch (error) {
                console.error('❌ taskpane.html initialization failed:', error);
            }
        });

    </script>
</body>

</html>
